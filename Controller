// =====================================================
// CONTROLLER.gs ‚Äì VERS√ÉO COM DASHBOARD INTEGRADO
// =====================================================

/**
 * Ponto de Entrada: Renderiza a estrutura base (Index)
 */
function doGet(e) {
  return HtmlService.createTemplateFromFile('Index')
    .evaluate()
    .setTitle('Rodrigues Novais CRM')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL)
    .addMetaTag('viewport', 'width=device-width, initial-scale=1');
}

/**
 * Utilit√°rio para incluir parciais (CSS/JS)
 */
function include(filename) {
  return HtmlService.createHtmlOutputFromFile(filename).getContent();
}

// =====================================================
// M√ìDULO DE INTEGRA√á√ïES EXTERNAS (Tasks, Calendar, TJDFT)
// =====================================================

/**
 * 1. GOOGLE TASKS
 * Busca tarefas da lista "Escrit√≥rio"
 */
function apiGetTasks() {
  try {
    // Tenta obter as listas de tarefas do usu√°rio
    const taskLists = Tasks.Tasklists.list();
    if (!taskLists.items) return [];

    const lista = taskLists.items.find(l => l.title === "Escrit√≥rio");
    if (!lista) return [{ title: "Crie a lista 'Escrit√≥rio'" }];

    const tasks = Tasks.Tasks.list(lista.id, { showCompleted: false });
    return (tasks.items || []).map(t => ({ title: t.title }));
    
  } catch (e) {
    Logger.log("Erro no Tasks: " + e.message);
    // Se der erro de permiss√£o, o retorno abaixo aparece no Dashboard
    return [{ title: "Erro: Autorize o acesso ao Tasks" }];
  }
}

/**
 * 2. CALEND√ÅRIO TJDFT (Scraper Real com Cache)
 * L√™: https://www.tjdft.jus.br/feriados-e-expedientes-suspensos
 */
/**
 * CALEND√ÅRIO TJDFT 2026 - BASEADO NA LISTA OFICIAL FORNECIDA
 */
function apiGetFeriadosTJDFT() {
  const base = [
    "16/02/2026 FERIADO FORENSE", "17/02/2026 FERIADO FORENSE", "18/02/2026 QUARTA-FEIRA DE CINZAS",
    "01/04/2026 SEMANA SANTA", "02/04/2026 SEMANA SANTA", "03/04/2026 SEMANA SANTA",
    "20/04/2026 PONTO FACULTATIVO", "21/04/2026 TIRADENTES", "01/05/2026 DIA DO TRABALHO",
    "04/06/2026 CORPUS CHRISTI", "11/08/2026 DIA DO ADVOGADO", "07/09/2026 INDEPEND√äNCIA",
    "12/10/2026 N. SRA. APARECIDA", "02/11/2026 FINADOS", "15/11/2026 PROCLAMA√á√ÉO DA REP√öBLICA",
    "20/11/2026 CONSCI√äNCIA NEGRA", "08/12/2026 DIA DA JUSTI√áA", "20/12/2026 RECESSO FORENSE"
  ];

  // Data de hoje sem horas para compara√ß√£o justa
  const hoje = new Date();
  hoje.setHours(0,0,0,0);

  const resultado = base.map(item => {
    const dataPartes = item.substring(0, 10).split('/');
    const d = parseInt(dataPartes[0], 10);
    const m = parseInt(dataPartes[1], 10) - 1;
    const y = parseInt(dataPartes[2], 10);
    const dataObj = new Date(y, m, d);
    
    return {
      data: item.substring(0, 5),
      nome: item.substring(11),
      val: dataObj.getTime()
    };
  })
  .filter(f => f.val >= hoje.getTime()) // Filtra feriados futuros ou de hoje
  .sort((a, b) => a.val - b.val) // Garante a ordem cronol√≥gica
  .slice(0, 6); // Pega os 6 primeiros

  return resultado;
}

function apiGetHistorico(numProcesso) {
  const json = TVOCore.apiObterHistorico(numProcesso);
  return JSON.parse(json || "[]");
}

function apiVincular(idProcesso, idCliente) {
  const res = JSON.parse(TVOCore.apiVincularCliente(idProcesso, idCliente));
  if (res.erro) throw new Error(res.erro);
  return res;
}

function apiGetFilaWhatsapp() {
  return JSON.parse(TVOCore.apiGetFilaWhatsapp() || "[]");
}
// E a rota getPageNotificacoes continua a mesma


/**
 * 3. SYNC CALENDAR (L√≥gica 0x61 Completa)
 * Cria eventos na agenda e verifica conflitos
 */
function apiGetAlertas() {
  const alertas = [];
  try {
    // Busca dados da planilha
    const json = TVOCore.getMovimentacoesSafe ? TVOCore.getMovimentacoesSafe() : "[]";
    const movs = JSON.parse(json);
    
    // Filtra audi√™ncias
    const audiencias = movs.filter(m => 
      m.DESCRICAO && m.DESCRICAO.toUpperCase().includes("AUDI√äNCIA")
    );

    if (audiencias.length === 0) return [];

    const calendar = CalendarApp.getDefaultCalendar();
    const hoje = new Date();
    const limiteFuturo = new Date();
    limiteFuturo.setDate(hoje.getDate() + 90); // Olha 90 dias pra frente

    // Pega todos os eventos dos pr√≥ximos 3 meses para comparar de uma vez (mais r√°pido)
    const eventosFuturos = calendar.getEvents(hoje, limiteFuturo);

    audiencias.forEach(aud => {
      if (!aud.DATA_MOV) return;
      const dataAud = new Date(aud.DATA_MOV);
      
      // Verifica se j√° existe evento nesse hor√°rio no Calendar
      const conflito = eventosFuturos.find(ev => 
        Math.abs(ev.getStartTime() - dataAud) < 60000 // Diferen√ßa menor que 1 min
      );

      if (conflito) {
        // Se j√° existe, verificamos se h√° SOBREPOSI√á√ÉO com OUTRO evento
        const outros = eventosFuturos.filter(ev => 
          ev.getStartTime() <= dataAud && ev.getEndTime() >= dataAud && ev.getId() !== conflito.getId()
        );
        
        if (outros.length > 0) {
          alertas.push({
            titulo: "‚ö†Ô∏è CHOQUE DE HOR√ÅRIO",
            data: dataAud.toLocaleDateString('pt-BR'),
            detalhe: `Audi√™ncia colide com: ${outros[0].getTitle()}`
          });
        }
      } else {
        // L√ìGICA DE CRIA√á√ÉO AUTOM√ÅTICA (Sync 0x61)
        // Se n√£o tem evento, o sistema DEVERIA criar.
        // Por seguran√ßa, apenas avisamos que falta criar por enquanto.
        alertas.push({
          titulo: "üìÖ Falta Adicionar √† Agenda",
          data: dataAud.toLocaleDateString('pt-BR'),
          detalhe: `Audi√™ncia do Proc. ${aud.PROCESSO_NUM}`
        });
        
        // Se quiser que crie sozinho, descomente a linha abaixo:
        // calendar.createEvent("Audi√™ncia: " + aud.PROCESSO_NUM, dataAud, new Date(dataAud.getTime() + 3600000));
      }
    });

    return alertas;

  } catch (e) {
    Logger.log("Erro Sync Calendar: " + e.message);
    return [];
  }
}

/**
 * Atualiza√ß√£o da estat√≠stica (Dashboard)
 */
function apiGetDashboardStats() {
  try {
    var clientes = apiListarClientes();
    var processos = apiListarProcessos();

    return {
      totalClientes: Array.isArray(clientes) ? clientes.length : 0,
      totalProcessos: Array.isArray(processos) ? processos.length : 0
    };
  } catch (e) {
    return { totalClientes: 0, totalProcessos: 0 };
  }
}

// =====================================================
// ROTEAMENTO DE P√ÅGINAS
// =====================================================

function getPageClientes() { 
  return include('Page_Clientes'); 
}

function getPageProcessos() { 
  return include('Page_Processos'); 
}

// [NOVO] Rota para o Dashboard
function getPageDashboard() {
  return include('Page_Dashboard');
}

// =====================================================
// API GATEWAY PARA A BIBLIOTECA (TVOCore)
// =====================================================

/**
 * API: Listar Clientes
 */
function apiListarClientes() {
  try {
    return TVOCore.listarClientes();
  } catch (e) {
    Logger.log("Erro ao listar clientes: " + e.message);
    return [];
  }
}

/**
 * API: Listar Processos ‚Äì vers√£o DEFINITIVA e SEGURA
 */
function apiListarProcessos() {
  try {
    // Verifica se a fun√ß√£o segura existe na biblioteca
    if (typeof TVOCore.getProcessosSafe === 'function') {
      var respostaJson = TVOCore.getProcessosSafe();

      // Garante que veio algo v√°lido
      if (!respostaJson) {
        Logger.log("getProcessosSafe retornou vazio");
        return [];
      }

      var dados = JSON.parse(respostaJson);

      // Se a pr√≥pria biblioteca retornou erro
      if (dados.erro) {
        throw new Error(dados.erro);
      }

      return dados;

    } else {
      // Fallback caso a vers√£o segura n√£o exista
      return TVOCore.listarProcessos();
    }
  } catch (e) {
    Logger.log("Erro no Controller apiListarProcessos: " + e.message);
    return [];
  }
}

/**
 * API: Salvar Cliente
 */
function apiSalvarCliente(form) {
  try {
    return TVOCore.salvarCliente(form);
  } catch (e) {
    Logger.log("Erro ao salvar cliente: " + e.message);
    throw new Error("Erro no Core: " + e.message);
  }
}

/**
 * [NOVO] API: Estat√≠sticas para o Dashboard
 * Reutiliza as fun√ß√µes seguras acima para contar os totais
 */
function apiGetDashboardStats() {
  try {
    // Busca as listas usando as fun√ß√µes que j√° tratam erros
    var clientes = apiListarClientes();
    var processos = apiListarProcessos(); // Usa a vers√£o blindada automaticamente

    return {
      totalClientes: Array.isArray(clientes) ? clientes.length : 0,
      totalProcessos: Array.isArray(processos) ? processos.length : 0,
      movsHoje: 0 // Implementaremos futuramente com a aba Movimenta√ß√µes
    };
    
  } catch (e) {
    Logger.log("Erro ao gerar estat√≠sticas: " + e.message);
    // Retorna tra√ßos em vez de erro para n√£o quebrar o layout visual
    return { totalClientes: '-', totalProcessos: '-', movsHoje: '-' };
  }
}

/**
 * Endpoint de diagn√≥stico r√°pido
 */
function healthCheck() {
  return {
    status: 'online',
    biblioteca: (typeof TVOCore !== 'undefined')
  };
}
